<ng-container *ngIf="window && window.isCollapsed">
	<div class="ng-chat-title secondary-background">
		<div class="ng-chat-title-visibility-toggle-area" (click)="onChatWindowClicked(window)">
			<strong title="{{window.participant.displayName}}">
				{{window.participant.displayName}}
			</strong>
			<span
				[ngClass]="{'ng-chat-participant-status': true, 'online': window.participant.status == ChatParticipantStatus.Online, 'busy': window.participant.status == ChatParticipantStatus.Busy, 'away': window.participant.status == ChatParticipantStatus.Away, 'offline': window.participant.status == ChatParticipantStatus.Offline}"
				title="{{chatParticipantStatusDescriptor(window.participant.status, localization)}}"></span>
			<span *ngIf="unreadMessagesTotal(window).length > 0"
				class="ng-chat-unread-messages-count unread-messages-counter-container primary-text">{{unreadMessagesTotal(window)}}</span>
		</div>
		<a href="javascript:void(0);" class="ng-chat-close primary-text" (click)="onCloseChatWindow()">X</a>
	</div>
</ng-container>
<ng-container *ngIf="window && !window.isCollapsed">
	<div class="ng-chat-title secondary-background">
		<div class="ng-chat-title-visibility-toggle-area" (click)="onChatWindowClicked(window)">
			<strong title="{{window.participant.displayName}}">
				{{window.participant.displayName}}
			</strong>
			<span
				[ngClass]="{'ng-chat-participant-status': true, 'online': window.participant.status == ChatParticipantStatus.Online, 'busy': window.participant.status == ChatParticipantStatus.Busy, 'away': window.participant.status == ChatParticipantStatus.Away, 'offline': window.participant.status == ChatParticipantStatus.Offline}"
				title="{{chatParticipantStatusDescriptor(window.participant.status, localization)}}"></span>
			<span *ngIf="unreadMessagesTotal(window).length > 0"
				class="ng-chat-unread-messages-count unread-messages-counter-container primary-text">{{unreadMessagesTotal(window)}}</span>
		</div>
		<a href="javascript:void(0);" class="ng-chat-close primary-text" (click)="onCloseChatWindow()">X</a>
		<ng-chat-options [ngClass]="'ng-chat-options-container'" [options]="defaultWindowOptions(window)"
			(activeOptionTrackerChange)="activeOptionTrackerChange($event)"></ng-chat-options>
	</div>
	<div #chatMessages class="ng-chat-messages primary-background">
		<div *ngIf="window.isLoadingHistory" class="ng-chat-loading-wrapper">
			<div class="loader">Loading history...</div>
		</div>
		<div *ngIf="hasPagedHistory && window.hasMoreMessages && !window.isLoadingHistory" class="ng-chat-load-history">
			<a class="load-history-action"
				(click)="fetchMessageHistory(window)">{{localization.loadMessageHistoryPlaceholder}}</a>
		</div>

		<div *ngFor="let message of window.messages; let i = index"
			[ngClass]="{'ng-chat-message': true, 'ng-chat-message-received': message.fromId != userId}">
			<ng-container *ngIf="isAvatarVisible(window, message, i)">
				<div *ngIf="!getChatWindowAvatar(window.participant, message)" class="icon-wrapper">
					<i class="user-icon"></i>
				</div>
				<img *ngIf="getChatWindowAvatar(window.participant, message)" alt="" class="avatar" height="30"
					width="30" [src]="getChatWindowAvatar(window.participant, message) | sanitize" />
				<span *ngIf="window.participant.participantType == ChatParticipantType.Group"
					class="ng-chat-participant-name">{{window.participant | groupMessageDisplayName:message}}</span>
			</ng-container>
			<ng-container [ngSwitch]="message.type">
				<div *ngSwitchCase="MessageType.Text"
					[ngClass]="{'sent-chat-message-container': message.fromId == userId, 'received-chat-message-container': message.fromId != userId}">
					<span [innerHtml]="message.message | emojify:emojisEnabled | linkfy:linkfyEnabled"></span>
					<span *ngIf="showMessageDate && message.dateSent" class="message-sent-date">{{message.dateSent |
						date:messageDatePipeFormat}}</span>
				</div>

				<ng-container *ngSwitchCase="MessageType.Image">
					<ng-container *ngTemplateOutlet="imageMessageTemplate ? imageMessageTemplate : defaultImageMessageTemplate; context: {message}"></ng-container>
				</ng-container>

				<ng-container *ngSwitchCase="MessageType.File">
					<ng-container *ngTemplateOutlet="fileMessageTemplate ? fileMessageTemplate : defaultFileMessageTemplate; context: {message}"></ng-container>
				</ng-container>

			</ng-container>
		</div>
	</div>

	<div class="ng-chat-footer primary-outline-color primary-background">
		<input #chatWindowInput type="text" [ngModel]="window.newMessage | emojify:emojisEnabled"
			(ngModelChange)="window.newMessage=$event" [placeholder]="localization.messagePlaceholder"
			[ngClass]="{'chat-window-input': true, 'has-side-action': fileUploadAdapter}"
			(keydown)="onChatInputTyped($event, window)" (blur)="toggleWindowFocus(window)"
			(focus)="toggleWindowFocus(window)" />

		<!-- File Upload -->
		<ng-container *ngIf="fileUploadAdapter">
			<a *ngIf="!isUploadingFile(window)" class="btn-add-file" (click)="triggerNativeFileUpload(window)">
				<i class="upload-icon"></i>
			</a>
			<input type="file" #nativeFileInput style="display: none;" [attr.id]="getUniqueFileUploadInstanceId(window)"
				(change)="onFileChosen(window)" />
			<div *ngIf="isUploadingFile(window)" class="loader"></div>
		</ng-container>
		<div ngbDropdown class="emoji-block" *ngIf="emojisEnabled">
			<span title="Emoji" ngbDropdownToggle>
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18">
					<path d="M12 0a12 12 0 1 0 0 24 12 12 0 0 0 0-24m0 22a10 10 0 1 1 0-20 10 10 0 0 1 0 20M8 7a2 2 0 1 0 0 4 2 2 0 0 0 0-4m8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4m-.8 8c-.7 1.2-1.8 2-3.3 2-1.5 0-2.7-.8-3.4-2H15m3-2H6a6 6 0 1 0 12 0"></path>
				</svg>
			</span>
			<div ngbDropdownMenu class="dropdown-content">
				<emoji-mart [style]="{ width: '302px'}" (emojiClick)="addEmoji($event, window)" [exclude]="[]" [sheetSize]="sheetSize" [showPreview]="false"></emoji-mart>
			</div>
		</div>
	</div>
</ng-container>

<ng-template #defaultImageMessageTemplate let-message="message">
	<div [ngClass]="{'sent-chat-message-container': message.fromId == userId, 'received-chat-message-container': message.fromId != userId}">
		<img [src]="message.mediaUrl" class="image-message" />
		<span [innerHtml]="message.message | emojify:emojisEnabled | linkfy:linkfyEnabled"></span>
		<span *ngIf="showMessageDate && message.dateSent" class="message-sent-date">{{message.dateSent |
			date:messageDatePipeFormat}}</span>
	</div>
</ng-template>

<ng-template #defaultFileMessageTemplate let-message="message">
	<div [ngClass]="{'file-message-container': true, 'received': message.fromId != userId}">
		<div class="file-message-icon-container">
			<i class="paperclip-icon"></i>
		</div>
		<a class="file-details" [attr.href]="message?.downloadUrl" target="_blank" rel="noopener noreferrer"
			(click)="markMessagesAsRead([message])" download>
			<span class="file-message-title" [attr.title]="message.message">{{message.message}}</span>
			<span *ngIf="message?.fileSizeInBytes" class="file-message-size">
				{{message?.fileSizeInBytes}} Bytes
			</span>
		</a>
	</div>
</ng-template>